
Cypress.on('uncaught:exception', (err, runnable) => {
  // returning false here prevents Cypress from failing the test
  return false;
});

describe("Generated: Action Integrity", { tags: ["@integrity", "@functional"] }, () => {
    const cfg = {"roles":["guest","client","psw","manager","staff"],"global":{"mandatory":["page.container","page.header","page.title","nav.main","toast","state.loading"],"selectors":{"sidebar":"sidebar","topbar":"topbar","logout":"btn-logout","toast":"toast","loading":"state.loading","error":"state.error","empty":"state.empty","accessDenied":"state.accessDenied"}},"pages":[{"key":"MARKETING_HOME","path":"/","baseUrlEnv":"WEB_MARKETING_BASE_URL","allowedRoles":["guest","any"],"components":["logo-link","link-family-portal","link-staff-hub","btn-book-assessment"],"actions":[{"key":"bookAssessment","selector":"btn-book-assessment","type":"route","target":"/book-now"},{"key":"loginFamily","selector":"link-family-portal","type":"route","target":"/login"},{"key":"loginStaff","selector":"link-staff-hub","type":"route","target":"/staff-login"}]},{"key":"MARKETING_CONTACT","path":"/contact","baseUrlEnv":"WEB_MARKETING_BASE_URL","allowedRoles":["guest","any"],"components":["inp-name","inp-email","inp-phone","inp-message","btn-submit-contact"],"actions":[{"key":"submitContact","selector":"btn-submit-contact","type":"api","endpoint":"/leads","method":"POST","expectedToasts":["contact-success"]}]},{"key":"AUTH_LOGIN","path":"/login","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["guest"],"components":["inp-email","inp-password","btn-login"],"actions":[{"key":"login","selector":"btn-login","type":"api","endpoint":"/auth/login","method":"POST"}]},{"key":"ADMIN_DASHBOARD","path":"/dashboard","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff","manager"],"components":["qa-link-users","qa-link-schedule","qa-link-leads","qa-link-settings"],"actions":[{"key":"navUsers","selector":"qa-link-users","type":"route","target":"/users"},{"key":"navSchedule","selector":"qa-link-schedule","type":"route","target":"/schedule"},{"key":"navLeads","selector":"qa-link-leads","type":"route","target":"/leads"},{"key":"navSettings","selector":"qa-link-settings","type":"route","target":"/settings"}]},{"key":"ADMIN_USERS","path":"/users","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["btn-invite-user","tbl-users"],"actions":[{"key":"inviteUser","selector":"btn-invite-user","type":"api","endpoint":"/users/invite","method":"POST"}]},{"key":"ADMIN_SCHEDULE","path":"/schedule","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff","manager"],"components":["calendar-container","btn-create-shift"],"actions":[{"key":"createShift","selector":"btn-create-shift","type":"api","endpoint":"/shifts","method":"POST"}]},{"key":"ADMIN_SERVICES","path":"/services","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["btn-add-service","tbl-services"],"actions":[{"key":"addService","selector":"btn-add-service","type":"api","endpoint":"/services","method":"POST"}]},{"key":"ADMIN_SETTINGS","path":"/settings","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["chk-email-alerts","chk-auto-assign","btn-save-settings"],"integrity":"guard.unsaved","actions":[{"key":"saveSettings","selector":"btn-save-settings","type":"api","endpoint":"/settings","method":"PATCH"}]},{"key":"MANAGER_DASHBOARD","path":"/manager/dashboard","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["manager"],"components":["mgr-dashboard"],"actions":[{"key":"navDailyEntry","selector":"qa-daily-entry","type":"route","target":"/manager/daily-entry"}]},{"key":"MANAGER_DAILY_ENTRY","path":"/manager/daily-entry","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["manager"],"components":["daily-entry-page","client-select","vitals-bp","notes","submit-entry"],"integrity":"guard.unsaved","actions":[{"key":"submitEntry","selector":"submit-entry","type":"api","endpoint":"/daily-entry/submit","method":"POST"}]},{"key":"PSW_SHIFTS","path":"/shifts","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["psw"],"components":["sidebar","topbar"],"actions":[]},{"key":"CLIENT_BOOKINGS","path":"/bookings","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["client"],"components":["sidebar","topbar"],"actions":[]},{"key":"SHARED_PROFILE","path":"/profile","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["client","psw","manager","staff"],"components":["btn-save-settings","profile-form"],"integrity":"guard.unsaved","actions":[{"key":"saveProfile","selector":"btn-save-settings","type":"api","endpoint":"/profile","method":"PATCH"}]},{"key":"MANAGER_EVALUATION","path":"/manager/evaluation","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["manager"],"components":["evaluation-form","inp-evaluation-score","btn-submit-evaluation"],"actions":[{"key":"submitEvaluation","selector":"btn-submit-evaluation","type":"api","endpoint":"/evaluations","method":"POST"}]},{"key":"MANAGER_SERVICE_REVIEW","path":"/manager/service-review","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["manager"],"components":["service-review-form","btn-submit-review"],"actions":[{"key":"submitReview","selector":"btn-submit-review","type":"api","endpoint":"/service-reviews","method":"POST"}]},{"key":"PSW_EXPENSE_REPORT","path":"/expenses","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["psw"],"components":["expense-form","btn-submit-expense"],"actions":[{"key":"submitExpense","selector":"btn-submit-expense","type":"api","endpoint":"/expenses","method":"POST"}]},{"key":"PSW_AVAILABILITY","path":"/availability","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["psw"],"components":["availability-form","btn-save-availability"],"actions":[{"key":"saveAvailability","selector":"btn-save-availability","type":"api","endpoint":"/availability","method":"PUT"}]},{"key":"CLIENT_FEEDBACK","path":"/feedback","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["client"],"components":["feedback-form","btn-submit-feedback"],"actions":[{"key":"submitFeedback","selector":"btn-submit-feedback","type":"api","endpoint":"/feedback","method":"POST"}]},{"key":"SHARED_VISIT_COMPLETION","path":"/visits/complete","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["psw"],"components":["visit-completion-form","sig-client","btn-complete-visit"],"actions":[{"key":"completeVisit","selector":"btn-complete-visit","type":"api","endpoint":"/visits/complete","method":"POST"}]},{"key":"CLIENT_BOOKING_REQUEST","path":"/bookings/new","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["client"],"components":["booking-request-form","btn-request-booking"],"actions":[{"key":"requestBooking","selector":"btn-request-booking","type":"api","endpoint":"/bookings/request","method":"POST"}]},{"key":"SHARED_SUPPORT_TICKET","path":"/support/new","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["client","psw","manager","staff"],"components":["support-ticket-form","btn-submit-ticket"],"actions":[{"key":"submitTicket","selector":"btn-submit-ticket","type":"api","endpoint":"/support/tickets","method":"POST"}]},{"key":"ADMIN_LOCATIONS","path":"/locations","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["location-form","btn-add-location"],"actions":[{"key":"addLocation","selector":"btn-add-location","type":"api","endpoint":"/locations","method":"POST"}]},{"key":"ADMIN_USER_ENTRY","path":"/users/new","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["user-entry-form","btn-create-user"],"actions":[{"key":"createUser","selector":"btn-create-user","type":"api","endpoint":"/users","method":"POST"}]},{"key":"ADMIN_INCIDENT_ENTRY","path":"/incidents/new","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff","manager"],"components":["incident-entry-form","btn-report-incident"],"actions":[{"key":"reportIncident","selector":"btn-report-incident","type":"api","endpoint":"/incidents","method":"POST"}]},{"key":"ADMIN_TIMESHEET_ADJ","path":"/timesheets/adjust","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["timesheet-adj-form","btn-apply-adjustment"],"actions":[{"key":"applyAdjustment","selector":"btn-apply-adjustment","type":"api","endpoint":"/timesheets/adjust","method":"POST"}]},{"key":"ADMIN_LEAD_ENTRY","path":"/leads/new","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff","manager"],"components":["lead-entry-form","btn-create-lead"],"actions":[{"key":"createLead","selector":"btn-create-lead","type":"api","endpoint":"/leads","method":"POST"}]},{"key":"ADMIN_ROLE_EDITOR","path":"/roles/edit","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["role-editor","btn-save-role"],"actions":[{"key":"saveRole","selector":"btn-save-role","type":"api","endpoint":"/roles","method":"PATCH"}]},{"key":"ADMIN_TEMPLATE_EDITOR","path":"/templates","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["template-editor","btn-save-template"],"actions":[{"key":"saveTemplate","selector":"btn-save-template","type":"api","endpoint":"/templates","method":"PATCH"}]},{"key":"ADMIN_INVOICE_ENTRY","path":"/invoices/new","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["staff"],"components":["invoice-entry-form","btn-generate-invoice"],"actions":[{"key":"generateInvoice","selector":"btn-generate-invoice","type":"api","endpoint":"/invoices","method":"POST"}]},{"key":"PSW_SHIFT_CONFIRMATION","path":"/shifts/confirm","baseUrlEnv":"WEB_ADMIN_BASE_URL","allowedRoles":["psw"],"components":["shift-confirmation","btn-accept-shift"],"actions":[{"key":"acceptShift","selector":"btn-accept-shift","type":"api","endpoint":"/shifts/confirm","method":"POST"}]}]};

    cfg.pages.filter(p => p.actions.length > 0).forEach((page: any) => {
        describe(`Page Actions: ${page.key}`, () => {
            beforeEach(() => {
                cy.loginAs(page.allowedRoles[0]);
                const baseUrlEnv = page.baseUrlEnv || "ADMIN_BASE_URL";
                cy.visitRoute(baseUrlEnv, page.path);
            });

            page.actions.forEach((action: any) => {
                it(`Action: ${action.key} triggers correct functional lifecycle`, () => {
                    if (action.type === "api") {
                        cy.intercept(action.method, "**" + action.endpoint + "**").as("apiCall");
                        
                        cy.log(`Triggering action: ${action.key}`);
                        cy.getByCy(action.selector).click();
                        
                        // Lifecycle checks
                        cy.getByCy("state.loading").should("exist").then(() => {
                            cy.wait("@apiCall");
                            if (action.expectedToasts) {
                                action.expectedToasts.forEach((t: string) => cy.getByCy(t).should("be.visible"));
                            } else {
                                cy.getByCy("toast.success").should("be.visible");
                            }
                        });
                    } else if (action.type === "route") {
                        cy.log(`Triggering navigation: ${action.key}`);
                        cy.getByCy(action.selector).click();
                        cy.url().should("include", action.target);
                    }
                });

                if (page.integrity === "guard.unsaved" && action.type === "api") {
                    it(`Action: ${action.key} enforces unsaved changes guard`, () => {
                        cy.log("Modifying form to trigger dirty state");
                        // Generic input for guard test (simplified)
                        cy.get("input").first().type("Guard Test");
                        
                        cy.log("Attempting to leave page");
                        cy.getByCy("sidebar").find("a").last().click();
                        
                        cy.log("Verifying guard dialog");
                        cy.getByCy("guard.unsaved.dialog").should("be.visible");
                        cy.getByCy("guard.unsaved.stay").click();
                        cy.getByCy("guard.unsaved.dialog").should("not.exist");
                    });
                }
            });
        });
    });
});
